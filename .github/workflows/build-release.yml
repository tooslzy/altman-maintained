name: Build and Release (Manual)

on:
    workflow_dispatch: {}

permissions:
    contents: write

jobs:
    build-and-release:
        runs-on: windows-latest

        env:
            VCPKG_ROOT: C:\vcpkg
            VCPKG_DEFAULT_BINARY_CACHE: ${{ github.workspace }}\.cache\vcpkg\archives

        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup MSVC
              uses: ilammy/msvc-dev-cmd@v1

            - name: Cache vcpkg binary packages
              uses: actions/cache@v4
              with:
                  path: .cache\vcpkg\archives
                  key: vcpkg-archives-${{ runner.os }}-x64-windows-static-${{ hashFiles('**/vcpkg.json', '**/vcpkg-configuration.json', '**/vcpkg-lock.json') }}
                  restore-keys: |
                      vcpkg-archives-${{ runner.os }}-x64-windows-static-

            - name: Clone vcpkg
              run: |
                  git clone --depth 1 https://github.com/microsoft/vcpkg.git C:\vcpkg
                  C:\vcpkg\bootstrap-vcpkg.bat

            - name: Install dependencies
              run: C:\vcpkg\vcpkg.exe install --triplet x64-windows-static

            - name: Configure
              run: cmake -B build -S . -DCMAKE_TOOLCHAIN_FILE=C:\vcpkg\scripts\buildsystems\vcpkg.cmake -A x64 -DCMAKE_BUILD_TYPE=Release

            - name: Build
              run: cmake --build build --config Release -- /m

            - name: Package
              shell: pwsh
              run: |
                  $Commit = (git rev-parse --short HEAD).Trim()
                  $ReleaseDir = "build\altman\Release"
                  if (-not (Test-Path $ReleaseDir)) { throw "Release folder not found: $ReleaseDir" }

                  $Zip = "AltMan-$Commit.zip"
                  Compress-Archive -Path (Join-Path $ReleaseDir '*') -DestinationPath $Zip -Force

            - name: Create Release
              shell: pwsh
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  $Commit = (git rev-parse --short HEAD).Trim()
                  $Tag = "commit-$Commit"
                  gh release create $Tag "AltMan-$Commit.zip" `
                    --title "AltMan $Commit" `
                    --notes "Automated release for commit $Commit."
